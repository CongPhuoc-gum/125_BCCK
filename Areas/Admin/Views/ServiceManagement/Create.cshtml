@model _125_BCCK.Models.ViewModels.ServiceFormViewModel
@{
    ViewBag.Title = "Chỉnh Sửa Dịch Vụ";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-edit"></i> Chỉnh Sửa Dịch Vụ
    </h1>
    <a href="@Url.Action("Index")" class="btn btn-secondary btn-icon-split">
        <span class="icon text-white-50">
            <i class="fas fa-arrow-left"></i>
        </span>
        <span class="text">Quay Lại</span>
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-warning">
                <h6 class="m-0 font-weight-bold text-white">
                    <i class="fas fa-edit"></i> Chỉnh Sửa: @Model.ServiceName
                </h6>
            </div>
            <div class="card-body">
                @using (Html.BeginForm("Edit", "ServiceManagement", FormMethod.Post, new { @class = "needs-validation", enctype = "multipart/form-data" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.HiddenFor(m => m.ServiceId)
                    @Html.HiddenFor(m => m.ImageUrl)

                    <div class="form-group">
                        @Html.LabelFor(m => m.ServiceName, new { @class = "font-weight-bold" })
                        @Html.TextBoxFor(m => m.ServiceName, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.ServiceName, "", new { @class = "text-danger small" })
                    </div>

                    <div class="form-group">
                        @Html.LabelFor(m => m.Category, new { @class = "font-weight-bold" })
                        @Html.DropDownListFor(m => m.Category, (SelectList)ViewBag.Categories, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.Category, "", new { @class = "text-danger small" })
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                @Html.LabelFor(m => m.Price, new { @class = "font-weight-bold" })
                                <div class="input-group">
                                    @Html.TextBoxFor(m => m.Price, new { @class = "form-control", type = "number", min = "10000" })
                                    <div class="input-group-append">
                                        <span class="input-group-text">VNĐ</span>
                                    </div>
                                </div>
                                @Html.ValidationMessageFor(m => m.Price, "", new { @class = "text-danger small" })
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                @Html.LabelFor(m => m.Duration, new { @class = "font-weight-bold" })
                                <div class="input-group">
                                    @Html.TextBoxFor(m => m.Duration, new { @class = "form-control", type = "number", min = "5", max = "300" })
                                    <div class="input-group-append">
                                        <span class="input-group-text">phút</span>
                                    </div>
                                </div>
                                @Html.ValidationMessageFor(m => m.Duration, "", new { @class = "text-danger small" })
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        @Html.LabelFor(m => m.Description, new { @class = "font-weight-bold" })
                        @Html.TextAreaFor(m => m.Description, new { @class = "form-control", rows = "4" })
                        @Html.ValidationMessageFor(m => m.Description, "", new { @class = "text-danger small" })
                    </div>

                    <!-- Upload Image -->
                    <div class="form-group">
                        <label class="font-weight-bold">
                            <i class="fas fa-image"></i> Hình Ảnh Dịch Vụ
                        </label>

                        <!-- Input chọn file -->
                        <div class="custom-file">
                            <input type="file"
                                   class="custom-file-input"
                                   id="imageFile"
                                   name="ImageFile"
                                   accept="image/jpeg,image/png,image/gif,image/jpg"
                                   onchange="previewImage(event)" />
                            <label class="custom-file-label" for="imageFile" id="fileLabel">Chọn ảnh mới (nếu muốn thay đổi)...</label>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i>
                            Định dạng: JPG, PNG, GIF. Kích thước tối đa: 5MB.
                            <strong>Nếu không chọn ảnh mới, ảnh cũ sẽ được giữ nguyên.</strong>
                        </small>

                        <!-- Preview ảnh mới -->
                        <div id="imagePreview" class="mt-3" style="display: none;">
                            <p class="small text-success mb-2">
                                <i class="fas fa-check-circle"></i> Xem trước ảnh mới:
                            </p>
                            <img id="preview" src="#" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;" />
                            <button type="button" class="btn btn-sm btn-danger mt-2" onclick="clearImagePreview()">
                                <i class="fas fa-times"></i> Hủy ảnh mới
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            @Html.CheckBoxFor(m => m.IsActive, new { @class = "custom-control-input", id = "chkIsActive" })
                            @Html.LabelFor(m => m.IsActive, "Đang hoạt động", new { @class = "custom-control-label", @for = "chkIsActive" })
                        </div>
                    </div>

                    <hr />

                    <div class="form-group mb-0">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save"></i> Cập Nhật
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Hủy Bỏ
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow mb-4 border-warning">
            <div class="card-header py-3 bg-warning">
                <h6 class="m-0 font-weight-bold text-white">Thông Tin</h6>
            </div>
            <div class="card-body">
                <p class="small">
                    <strong>Mã dịch vụ:</strong> #@Model.ServiceId
                </p>
                <hr />
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Lưu ý:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Thay đổi giá chỉ áp dụng cho các lịch hẹn mới</li>
                        <li>Chỉ chọn ảnh mới nếu muốn thay đổi hình ảnh</li>
                        <li>Có thể chỉ sửa một vài thông tin, không cần sửa tất cả</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        // Preview ảnh khi chọn file
        function previewImage(event) {
            var input = event.target;
            var fileLabel = document.getElementById('fileLabel');
            var preview = document.getElementById('preview');
            var previewContainer = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                var file = input.files[0];

                // Kiểm tra kích thước file (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File quá lớn! Vui lòng chọn file nhỏ hơn 5MB.');
                    input.value = '';
                    fileLabel.textContent = 'Chọn ảnh mới (nếu muốn thay đổi)...';
                    previewContainer.style.display = 'none';
                    return;
                }

                // Kiểm tra định dạng
                var validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
                if (!validTypes.includes(file.type)) {
                    alert('Định dạng không hợp lệ! Vui lòng chọn file JPG, PNG hoặc GIF.');
                    input.value = '';
                    fileLabel.textContent = 'Chọn ảnh mới (nếu muốn thay đổi)...';
                    previewContainer.style.display = 'none';
                    return;
                }

                // Cập nhật tên file
                fileLabel.textContent = file.name;

                // Hiển thị preview
                var reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                fileLabel.textContent = 'Chọn ảnh mới (nếu muốn thay đổi)...';
                previewContainer.style.display = 'none';
            }
        }

        // Hủy preview ảnh mới
        function clearImagePreview() {
            var input = document.getElementById('imageFile');
            var fileLabel = document.getElementById('fileLabel');
            var previewContainer = document.getElementById('imagePreview');

            input.value = '';
            fileLabel.textContent = 'Chọn ảnh mới (nếu muốn thay đổi)...';
            previewContainer.style.display = 'none';
        }

        // Bootstrap custom file input
        $(document).ready(function () {
            $('.custom-file-input').on('change', function () {
                var fileName = $(this).val().split('\\').pop();
                if (fileName) {
                    $(this).next('.custom-file-label').addClass("selected").html(fileName);
                }
            });
        });
    </script>
}