@model _125_BCCK.Models.ViewModels.ProcessPaymentViewModel
@{
    ViewBag.Title = "Thu tiền phần còn lại";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container my-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-cash-register"></i> Thu tiền phần còn lại</h2>
            <a href="@Url.Action("Details", new { id = Model.AppointmentId })" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Thông tin lịch hẹn -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Thông tin lịch hẹn #@Model.AppointmentId</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Khách hàng:</strong> @Model.CustomerName</p>
                            <p><strong>Thú cưng:</strong> @Model.PetName</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Tổng tiền:</strong> <span class="text-primary">@Model.TotalPrice.ToString("N0") đ</span></p>
                            @if (Model.AlreadyPaid)
                            {
                                <p>
                                    <strong>Đã cọc:</strong>
                                    <span class="text-success">
                                        <i class="fas fa-check-circle"></i> @Model.DepositAmount.ToString("N0") đ
                                    </span>
                                </p>
                            }
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <h4 class="alert-heading">
                            <i class="fas fa-exclamation-triangle"></i> Số tiền cần thu
                        </h4>
                        <hr>
                        <h2 class="text-danger mb-0">@Model.RemainingAmount.ToString("N0") đ</h2>
                    </div>
                </div>
            </div>

            <!-- Form thanh toán -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Thông tin thanh toán</h5>
                </div>
                <div class="card-body">
                    @using (Html.BeginForm("ProcessPayment", "Staff", FormMethod.Post, new { @class = "needs-validation" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.AppointmentId)
                        @Html.HiddenFor(m => m.RemainingAmount)

                        <div class="mb-4">
                            <label class="form-label">
                                Phương thức thanh toán <span class="text-danger">*</span>
                            </label>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-check-inline payment-method-card">
                                        <input class="form-check-input" type="radio" name="PaymentMethod" id="pmCash" value="Cash" checked>
                                        <label class="form-check-label w-100" for="pmCash">
                                            <div class="p-3 border rounded text-center">
                                                <i class="fas fa-money-bill-wave fa-3x text-success mb-2"></i>
                                                <div><strong>Tiền mặt</strong></div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-check-inline payment-method-card">
                                        <input class="form-check-input" type="radio" name="PaymentMethod" id="pmBank" value="BankTransfer">
                                        <label class="form-check-label w-100" for="pmBank">
                                            <div class="p-3 border rounded text-center">
                                                <i class="fas fa-university fa-3x text-primary mb-2"></i>
                                                <div><strong>Chuyển khoản</strong></div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-check-inline payment-method-card">
                                        <input class="form-check-input" type="radio" name="PaymentMethod" id="pmCard" value="Card">
                                        <label class="form-check-label w-100" for="pmCard">
                                            <div class="p-3 border rounded text-center">
                                                <i class="fas fa-credit-card fa-3x text-info mb-2"></i>
                                                <div><strong>Thẻ</strong></div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-check-inline payment-method-card">
                                        <input class="form-check-input" type="radio" name="PaymentMethod" id="pmMomo" value="Momo">
                                        <label class="form-check-label w-100" for="pmMomo">
                                            <div class="p-3 border rounded text-center">
                                                <i class="fas fa-mobile-alt fa-3x text-danger mb-2"></i>
                                                <div><strong>Momo</strong></div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            @Html.ValidationMessageFor(m => m.PaymentMethod, "", new { @class = "text-danger" })
                        </div>

                        <div class="mb-3">
                            @Html.LabelFor(m => m.Notes, new { @class = "form-label" })
                            @Html.TextAreaFor(m => m.Notes, new { @class = "form-control", rows = 3, placeholder = "Ghi chú về giao dịch (tùy chọn)" })
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Lưu ý:</strong> Sau khi xác nhận, lịch hẹn sẽ được đánh dấu là đã thanh toán đầy đủ.
                        </div>

                        <!-- Tóm tắt thanh toán -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-receipt"></i> Tóm tắt thanh toán</h6>
                                <div class="d-flex justify-content-between">
                                    <span>Số tiền thu:</span>
                                    <strong class="text-danger" id="amountToCollect">@Model.RemainingAmount.ToString("N0") đ</strong>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <span>Phương thức:</span>
                                    <strong id="selectedMethod">Tiền mặt</strong>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success btn-lg flex-fill">
                                <i class="fas fa-check-circle"></i> Xác nhận thu tiền (@Model.RemainingAmount.ToString("N0") đ)
                            </button>
                            <a href="@Url.Action("Details", new { id = Model.AppointmentId })" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> Hủy
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section styles {
    <style>
        .payment-method-card {
            width: 100%;
        }

            .payment-method-card input[type="radio"] {
                display: none;
            }

                .payment-method-card input[type="radio"]:checked + label > div {
                    background-color: #e3f2fd;
                    border-color: #2196f3 !important;
                    border-width: 2px;
                }

            .payment-method-card label {
                cursor: pointer;
                margin: 0;
            }

                .payment-method-card label > div {
                    transition: all 0.3s;
                }

                    .payment-method-card label > div:hover {
                        background-color: #f5f5f5;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    }
    </style>
}

@section scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(document).ready(function() {
            // Cập nhật tóm tắt khi chọn phương thức
            $('input[name="PaymentMethod"]').change(function() {
                var methodText = $(this).next('label').find('strong').text();
                $('#selectedMethod').text(methodText);
            });

            // Xác nhận trước khi submit
            $('form').submit(function(e) {
                var amount = '@Model.RemainingAmount.ToString("N0")';
                var method = $('input[name="PaymentMethod"]:checked').next('label').find('strong').text();

                if (!confirm('Xác nhận thu ' + amount + ' đ bằng ' + method + '?')) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}